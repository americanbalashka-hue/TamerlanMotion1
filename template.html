<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>AR Фото-видео</title>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
body {
  margin: 0;
  background: black;
  height: 100vh;
  width: 100vw;
  overflow: hidden;
  font-family: Arial, sans-serif;
}
#container {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: black;
}
#startButton {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  padding: 18px 40px;
  font-size: 20px;
  font-weight: bold;
  background: #ff9900;
  color: #ffffff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  z-index: 10;
  transition: 0.2s;
}
#startButton:hover {
  background: #e68a00;
}
a-scene {
  width: 100%; height: 100%;
}
</style>
</head>
<body>
<div id="container">
  <button id="startButton">Нажмите, чтобы включить</button>

  <a-scene mindar-image="imageTargetSrc: {{MIND_FILE}};" embedded color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <video id="video1" src="{{VIDEO_FILE}}" preload="auto" playsinline webkit-playsinline muted loop></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="targetEntity">
      <a-video id="videoPlane" src="#video1" material="opacity: 0.8"></a-video>
    </a-entity>

  </a-scene>
</div>

<script>
const button = document.getElementById('startButton');
const videoEl = document.getElementById('video1');
const videoPlane = document.getElementById('videoPlane');
const targetEntity = document.getElementById('targetEntity');
let isPlaying = false;

// Запуск камеры и видео после клика
button.addEventListener('click', async () => {
  try {
    videoEl.muted = true; 
    await videoEl.play();
    button.style.display = 'none';
  } catch(err){
    console.error(err);
    alert('Не удалось запустить камеру/видео');
  }
});

// Автоподстройка видео под цель с сохранением пропорций
targetEntity.addEventListener('targetFound', () => {
  if (!isPlaying) {
    videoEl.muted = false;
    videoEl.currentTime = 0;
    videoEl.play().catch(e => console.log(e));
    isPlaying = true;
  }

  const targetObj = targetEntity.object3D.children[0];
  if(targetObj){
    const bbox = new THREE.Box3().setFromObject(targetObj);
    const targetSize = new THREE.Vector3();
    bbox.getSize(targetSize);

    // Сохраняем пропорции видео
    const aspect = videoEl.videoWidth / videoEl.videoHeight;
    let width = targetSize.x;
    let height = width / aspect;
    if(height > targetSize.y){
      height = targetSize.y;
      width = height * aspect;
    }

    videoPlane.setAttribute('width', width);
    videoPlane.setAttribute('height', height);
  }
});

targetEntity.addEventListener('targetLost', () => {
  videoEl.pause();
  videoEl.currentTime = 0;
  isPlaying = false;
});
</script>
</body>
</html>